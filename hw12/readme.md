### Работа с join'ами, статистикой

Цель:
- знать и уметь применять различные виды join'ов
- строить и анализировать план выполенения запроса
- оптимизировать запрос
- уметь собирать и анализировать статистику для таблицы

#### Подготовим ВМ

Для реализации домашнего задания использовалась VMWare Worstation, была поднята ВМ с ОС Ubuntu 20.04.1 desaktop + demo БД

1. Разрешим подключения к БД

```
daa@daa-pgsql:~$ echo "listen_addresses = '*'" | sudo tee -a /etc/postgresql/15/main/postgresql.conf
[sudo] password for daa:
listen_addresses = '*'
```

2. Разрешим подключение пользователей к базе, в т.ч. для физической репликации

```
daa@daa-pgsql:~$ echo "host all all 0.0.0.0/0 md5" | sudo tee -a /etc/postgresql/15/main/pg_hba.conf
host all all 0.0.0.0/0 md5
```

3. Перезапустим кластера 

```
sudo systemctl restart postgresql
```

4. Установим демо БД

https://postgrespro.ru/education/demodb

```
daa@daa-pgsql:~$ sudo psql -f demo-small-20170815.sql -U postgres
[sudo] password for daa:
Password for user postgres:
SET
SET
SET
...
ALTER TABLE
ALTER TABLE
ALTER DATABASE
ALTER DATABASE
```

Модель достаточно простая, но для решения ДЗ подходит.

![image](https://github.com/user-attachments/assets/244eb792-0ad1-4a24-8387-b3792adcf0d2)

#### Реализовать прямое соединение двух или более таблиц

Посмотрим, какое количество вылетов было у каждого самолета

```
select a.aircraft_code, a.model, count(f.*) количество_рейсов
from bookings.aircrafts_data a
         join bookings.flights f on a.aircraft_code = f.aircraft_code
group by 1
order by 3 desc

aircraft_code|model                                                     |количество_рейсов|
-------------+----------------------------------------------------------+-----------------+
CN1          |{"en": "Cessna 208 Caravan", "ru": "Сессна 208 Караван"}  |             9273|
CR2          |{"en": "Bombardier CRJ-200", "ru": "Бомбардье CRJ-200"}   |             9048|
SU9          |{"en": "Sukhoi Superjet-100", "ru": "Сухой Суперджет-100"}|             8504|
321          |{"en": "Airbus A321-200", "ru": "Аэробус A321-200"}       |             1952|
733          |{"en": "Boeing 737-300", "ru": "Боинг 737-300"}           |             1274|
319          |{"en": "Airbus A319-100", "ru": "Аэробус A319-100"}       |             1239|
763          |{"en": "Boeing 767-300", "ru": "Боинг 767-300"}           |             1221|
773          |{"en": "Boeing 777-300", "ru": "Боинг 777-300"}           |              610|
```

#### Реализовать левостороннее (или правостороннее) соединение двух или более таблиц

Попробуем добавить к нашему запросу left join и получим результат даже лучше, т.к. получим результаты по рейсу, который не имел вылетов.

```
select a.aircraft_code, a.model, count(f.*) количество_рейсов
from bookings.aircrafts_data a
        left join bookings.flights f on a.aircraft_code = f.aircraft_code
group by 1
order by 3 desc

aircraft_code|model                                                     |количество_рейсов|
-------------+----------------------------------------------------------+-----------------+
CN1          |{"en": "Cessna 208 Caravan", "ru": "Сессна 208 Караван"}  |             9273|
CR2          |{"en": "Bombardier CRJ-200", "ru": "Бомбардье CRJ-200"}   |             9048|
SU9          |{"en": "Sukhoi Superjet-100", "ru": "Сухой Суперджет-100"}|             8504|
321          |{"en": "Airbus A321-200", "ru": "Аэробус A321-200"}       |             1952|
733          |{"en": "Boeing 737-300", "ru": "Боинг 737-300"}           |             1274|
319          |{"en": "Airbus A319-100", "ru": "Аэробус A319-100"}       |             1239|
763          |{"en": "Boeing 767-300", "ru": "Боинг 767-300"}           |             1221|
773          |{"en": "Boeing 777-300", "ru": "Боинг 777-300"}           |              610|
320          |{"en": "Airbus A320-200", "ru": "Аэробус A320-200"}       |                0|
```

Попробуем еще что нибудь, например посчитаем количество человек, которые были перевезены этими самолетами

```
select a.aircraft_code, a.model, count(tf.*) Количество_пассажиров
from bookings.aircrafts_data a
         left join bookings.flights f on a.aircraft_code = f.aircraft_code
         left join bookings.ticket_flights tf on f.flight_id = tf.flight_id 
group by 1
order by 3 desc

aircraft_code|model                                                     |Количество_пассажиров|
-------------+----------------------------------------------------------+---------------------+
SU9          |{"en": "Sukhoi Superjet-100", "ru": "Сухой Суперджет-100"}|               365698|
CR2          |{"en": "Bombardier CRJ-200", "ru": "Бомбардье CRJ-200"}   |               150122|
773          |{"en": "Boeing 777-300", "ru": "Боинг 777-300"}           |               144376|
763          |{"en": "Boeing 767-300", "ru": "Боинг 767-300"}           |               124774|
321          |{"en": "Airbus A321-200", "ru": "Аэробус A321-200"}       |               107129|
733          |{"en": "Boeing 737-300", "ru": "Боинг 737-300"}           |                86102|
319          |{"en": "Airbus A319-100", "ru": "Аэробус A319-100"}       |                52853|
CN1          |{"en": "Cessna 208 Caravan", "ru": "Сессна 208 Караван"}  |                14672|
320          |{"en": "Airbus A320-200", "ru": "Аэробус A320-200"}       |                    0|
```

#### Реализовать кросс соединение двух или более таблиц




В результате выполнения ДЗ вы научитесь пользоваться
различными вариантами соединения таблиц.
В данном задании тренируются навыки:

написания запросов с различными типами соединений
Необходимо:
Реализовать прямое соединение двух или более таблиц
Реализовать левостороннее (или правостороннее)
соединение двух или более таблиц
Реализовать кросс соединение двух или более таблиц
Реализовать полное соединение двух или более таблиц
Реализовать запрос, в котором будут использованы
разные типы соединений
Сделать комментарии на каждый запрос
К работе приложить структуру таблиц, для которых
выполнялись соединения
Задание со звездочкой*
Придумайте 3 своих метрики на основе показанных представлений, отправьте их через ЛК, а так же поделитесь с коллегами в слаке
